<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Convertisseur dynamique Plomb Avant Travaux</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px;font-size:8pt}
.container{max-width:1200px;margin:auto;background:#fff;border-radius:10px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
h1{text-align:center;margin:8px 0}
.lead{text-align:center;color:#52606d;margin-top:0}

/* ===== HEADER SOCOTEC ===== */
.header-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.header-left{
  display:flex;
  align-items:center;
  gap:12px;
}
.header-left img{ height:42px; }
.header-actions{ display:flex; gap:8px; }
.header-actions a{
  text-decoration:none;
  padding:6px 10px;
  border-radius:8px;
  border:1px solid #2f80ed;
  color:#2f80ed;
  font-size:8pt;
  background:#f8fbff;
}
.header-actions a:hover{ background:#eaf3ff; }

/* ===== HI√âRARCHIE DES 3 PREMI√àRES LIGNES ===== */
.local-title td{
  background:#00ACE8;
  color:#fff;
  font-weight:700;
  font-size:11pt;
  text-transform:uppercase;
  letter-spacing:0.6px;
  border-top:1px solid #000;
}
.ur-title td{
  background:#d6e4f5;
  color:#000;
  font-weight:600;
  font-size:9.5pt;
}
.table-header th{
  background:#eef3f8;
  color:#000;
  font-weight:600;
  font-size:8.5pt;
  text-align:center;
  vertical-align:middle;
}

/* ===== EXISTANT ===== */
.upload{border:2px dashed #40a9ff;border-radius:8px;padding:18px;text-align:center;background:#f8fbff;cursor:pointer}
.upload.dragover{background:#eefaf1;border-color:#00b894}
input[type=file]{display:none}
.btn{padding:8px 14px;border-radius:8px;background:#2f80ed;color:#fff;border:none;cursor:pointer}
.btn-secondary{padding:8px 14px;border-radius:8px;background:#555;color:#fff;border:none;cursor:pointer}

.preview table{
  width:95%;
  max-width:25cm;
  margin:12px auto;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:8pt;
}
td,th{border:1px solid #000;padding:4px;word-wrap:break-word;vertical-align:top}

.panel{
  background:#f8fbff;
  border:1px solid #d7e6ff;
  border-radius:10px;
  padding:12px;
  margin:12px auto;
  width:90%;
  max-width:17cm;
}
.panel-flex{display:flex;gap:16px}
.panel-left{flex:1}
.panel-right{width:260px;background:#fff;border:1px solid #d7e6ff;border-radius:10px;padding:10px;font-size:8pt}

/* ===== PALETTE COULEURS ===== */
.palette-pop{
  display:none;
  position:absolute;
  z-index:20;
  background:#fff;
  border:1px solid #cfe2ff;
  border-radius:8px;
  padding:8px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
.palette-grid{
  display:grid;
  grid-template-columns:repeat(3,18px);
  gap:6px;
  margin-bottom:6px;
}
.color-swatch{
  width:18px;
  height:18px;
  border:2px solid #999;
  cursor:pointer;
}
.color-swatch.active{ border-color:#000; }
.hex-row{ display:flex; align-items:center; gap:6px; }
.hex-input{
  width:84px;
  font-size:8pt;
  padding:2px 4px;
  border:1px solid #999;
  border-radius:6px;
}
.hex-apply{
  padding:2px 6px;
  border-radius:6px;
  border:1px solid #999;
  background:#f7f7f7;
  cursor:pointer;
  font-size:8pt;
}
.slice-row{ position:relative; }
</style>
</head>

<body>

<div class="container">

<!-- ===== HEADER SOCOTEC ===== -->
<div class="header-top">
  <div class="header-left">
    <img src="https://raw.githubusercontent.com/lioneltissotbez-socotec/socotec-assets/main/logo.svg" alt="SOCOTEC">
    <div>
      <div style="font-weight:bold;font-size:9pt">SOCOTEC Diagnostics</div>
      <div style="font-size:8pt;color:#52606d">Outil interne ‚Äì Plomb avant travaux</div>
    </div>
  </div>

  <div class="header-actions">
    <a href="https://lioneltissotbez-socotec.github.io/outils_plomb/IDF_Plomb_Tvx_methode_normative_Saisie_Liciel_2025_11.pdf" target="_blank">üìÑ Voir la fiche m√©thodo</a>
    <a href="https://socotecgroup-my.sharepoint.com/:v:/g/personal/lionel_tissotbez_socotec_com/IQCg8GkQNSAUSrBa5Gf4JvRGAcFEY8vxwhCqnwXTfNUkRfM?e=X9Qx6J" target="_blank">üé• Voir le tuto d'utilisation</a>
  </div>
</div>

<h1>üî¨ Convertisseur dynamique Plomb Avant Travaux</h1>
<p class="lead">Traitement Liciel ‚Üí tableaux Word</p>

<div style="text-align:center;margin-bottom:10px">
  <button class="btn" id="pickBtn">Choisir un fichier</button>
  <button class="btn" id="processBtn" style="display:none">‚ñ∂Ô∏è Traiter</button>
</div>

<div id="uploadArea" class="upload">
  üìÅ Glisser / d√©poser ou cliquer
  <input type="file" id="fileInput" accept=".xlsx,.xls">
</div>

<!-- CLASSEMENT -->
<div class="panel panel-flex">
  <!-- CLASSEMENT -->
  <div class="panel-left">
    <b>üìÇ Classement</b><br><br>
<label>
  <input type="radio" name="groupMode" value="local-ur" checked>
  Local ‚Üí UR
</label><br>

<label>
  <input type="radio" name="groupMode" value="ur">
  UR ‚Äì toutes localisations
</label><br>

<label>
  <input type="radio" name="groupMode" value="ur-niveau">
  UR ‚Äì par niveau
</label><br>

<label>
  <input type="radio" name="groupMode" value="ur-local">
  UR ‚Äì par local
</label>

  </div>

  <!-- COLONNES OPTIONNELLES -->
  <div class="panel-right">
    <b>üß© Colonnes optionnelles</b><br><br>
    <label><input type="checkbox" id="showObs"> Observation (P)</label><br>
    <label><input type="checkbox" id="showDeg"> D√©gradation (M)</label><br>
    <label style="margin-left:12px">
      <input type="checkbox" id="obsCNPE">
      Observation CNPE (&lt;LQ / &gt;LQ)
    </label>
  </div>
</div>


<!-- OPTIONS -->
<div class="panel panel-flex">
  <div class="panel-left">
    <b>üé® Coloration & Incertitude ‚Äî Num√©ro d'UR</b><br><br>

    <b>Num√©rotation UR :</b><br>
    <label><input type="radio" name="urMode" value="excel" checked> Utiliser UR du fichier</label><br>
    <label><input type="radio" name="urMode" value="auto"> G√©n√©rer automatiquement</label>

    <br><br>
    <label><input type="checkbox" id="enableColors"> Activer la coloration</label><br><br>

    <label>Nombre de tranches :
      <input type="number" id="sliceCount" value="3" min="1" max="10">
    </label>

    <div id="slicesWrap" style="margin-top:6px"></div>

    <br>
    <label>
      Incertitude automatique (%) :
      <input type="number" id="uncertaintyPct" value="10" min="0" max="100" step="0.1">
    </label>

    <br><br>
  </div>

  <div class="panel-right">
    <b>Tranches UR m√©tier (mg/cm¬≤)</b>
    <ul>
      <li>0</li><li>0,01 ‚Üí 0,3</li><li>0,3 ‚Üí 0,7</li>
      <li>0,7 ‚Üí 1</li><li>1 ‚Üí 2</li><li>2 ‚Üí 5</li>
      <li>5 ‚Üí 10</li><li>&gt;10</li>
    </ul>
  </div>
</div>

<div style="text-align:center;margin:10px">
  <button class="btn-secondary" id="copyAllBtn">üìã Copier tous les tableaux</button>
</div>

<div id="previewContainer" class="preview" style="display:none">
  <div id="previewArea"></div>
</div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

/* ===================== R√âF√âRENCES DOM ===================== */
const uploadArea = document.getElementById("uploadArea");
const fileInput = document.getElementById("fileInput");
const pickBtn = document.getElementById("pickBtn");
const processBtn = document.getElementById("processBtn");
const previewArea = document.getElementById("previewArea");
const previewContainer = document.getElementById("previewContainer");
const enableColors = document.getElementById("enableColors");
const sliceCount = document.getElementById("sliceCount");
const slicesWrap = document.getElementById("slicesWrap");
const uncertaintyPct = document.getElementById("uncertaintyPct");
const copyAllBtn = document.getElementById("copyAllBtn");

const showObs = document.getElementById("showObs");
const showDeg = document.getElementById("showDeg");
const obsCNPE = document.getElementById("obsCNPE");

let rowsCache = [];

/* ===================== UPLOAD FICHIER ===================== */
pickBtn.onclick = () => fileInput.click();
uploadArea.onclick = () => fileInput.click();

fileInput.onchange = () => {
  if (fileInput.files.length) {
    handleFile(fileInput.files[0]);
  }
};

/* ===== DRAG & DROP ===== */
uploadArea.addEventListener('dragover', e => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', e => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');

  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
});

/* ===================== LECTURE EXCEL ===================== */
function handleFile(file) {
  const reader = new FileReader();

  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' }).slice(1);

    const IDX = { C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,M:12,P:15,Q:16,S:18 };

    rowsCache = data.map(r => ({
      C:r[IDX.C], D:r[IDX.D], E:r[IDX.E], F:r[IDX.F],
      G:r[IDX.G], H:r[IDX.H], I:r[IDX.I], J:r[IDX.J],
      K:r[IDX.K],
      M:r[IDX.M],
      P:r[IDX.P],
      Q:r[IDX.Q],
      S:r[IDX.S]
    }));

    processBtn.style.display = "inline-block";
  };

  reader.readAsArrayBuffer(file);
}

/* ===================== UTILITAIRES ===================== */
function splitLevelLocal(v){
  if(!v) return {level:'',local:''};
  const p=String(v).split('-');
  return {level:p[0]?.trim()||'', local:p.slice(1).join('-').trim()};
}

function parseNumber(v){
  return Number(String(v||'').replace(',','.').replace(/[^0-9.]/g,''));
}

function formatPlombValue(v){
  const n = parseNumber(v);
  if(isNaN(n)) return v || '';
  if(n === 0) return '0,00';
  return v;
}

function buildZone(it){
  return [it.E, it.J, it.S]
    .map(v => String(v||'').trim())
    .filter(Boolean)
    .join(' - ');
}

function isNonMesurable(it){
  return String(it.P || '').trim().toUpperCase() === 'NM';
}

/* ===================== RENDER ===================== */
processBtn.onclick=render;
enableColors.onchange=render;
showObs.onchange = render;
showDeg.onchange = render;
obsCNPE.onchange=render;
document.querySelectorAll('input[name="groupMode"]').forEach(r=>r.onchange=render);
document.querySelectorAll('input[name="urMode"]').forEach(r=>r.onchange=render);

function render(){
  previewArea.innerHTML='';
  let rows=[...rowsCache];

  const urMode=document.querySelector('input[name="urMode"]:checked').value;
  if(urMode==='auto') rows=computeAutoURNumbers(rows);

  const mode=document.querySelector('input[name="groupMode"]:checked').value;
  const COLS = colCount();
  const CG = colgroupHTML();

const thExtra_local = `
  ${showObs.checked ? `<th>Observation</th>` : ''}
  ${showDeg.checked ? `<th>D√©gradation</th>` : ''}
`;

const tdExtra_local = (it)=> `
 ${(showObs.checked || obsCNPE.checked) ? `<td>${getObservation(it) || ''}</td>` : ''}
  ${showDeg.checked ? `<td>${it.M||''}</td>` : ''}
`;

  // ===== MODE SPECIAL : Local ‚Üí UR =====
  if(mode === 'local-ur'){
    const localMap = new Map();

    rows.forEach(it=>{
      const {local} = splitLevelLocal(it.D);
      const locKey = (local || 'Local NR');
      if(!localMap.has(locKey)) localMap.set(locKey, []);
      localMap.get(locKey).push(it);
    });

    for(const [loc, items] of localMap){
      let html = `<table>${CG}
        <tr class="local-title"><td colspan="${COLS}">${loc}</td></tr>`;

      const urNameMap = new Map();
      items.forEach(it=>{
        const urKey = groupTitleBase(it);
        if(!urNameMap.has(urKey)) urNameMap.set(urKey, []);
        urNameMap.get(urKey).push(it);
      });

      for(const [urKey, urItems] of urNameMap){
        html += `<tr class="ur-title"><td colspan="${COLS}">UR : ${urKey}</td></tr>
        <tr class="table-header">
          <th>UR N¬∞</th>
          <th>N¬∞ mesure</th>
          <th>Niveau</th>
          <th>Unit√© de rep√©rage</th>
          <th>Zone</th>
          <th>Substrat</th>
          <th>Rev√™tement apparent</th>
          <th>Teneur en plomb en mg/cm¬≤</th>
          <th>Incertitude de la mesure +/- mg/cm¬≤</th>
		  ${thExtra_local}
        </tr>`;

        urItems.forEach(it=>{
          const {level} = splitLevelLocal(it.D);
          let inc = it.Q;
          const res = parseNumber(it.K);
          if((inc === '' || inc == null) && !isNaN(res)){
            inc = Math.max(0.01, res * (parseNumber(uncertaintyPct.value)/100)).toFixed(2);
          }
          const urVal = (urMode === 'auto') ? it.UR_AUTO : (it.F || '');

          html += `<tr>
            <td>${urVal}</td>
            <td>${it.C||''}</td>
            <td>${level}</td>
            <td>${it.G || ''}</td>
            <td>${buildZone(it)}</td>
            <td>${it.H||''}</td>
            <td>${it.I||''}</td>
            <td style="background:${getColor(it.K)}">${formatPlombValue(it.K)}</td>
            <td>${inc||''}</td>
			${tdExtra_local(it)}
          </tr>`;
        });
      }

      html += `</table>`;
      previewArea.insertAdjacentHTML("beforeend", html);
    }

    const legend = buildLegend();
    if(legend){
      previewArea.insertAdjacentHTML("beforeend", legend);
    }

    previewContainer.style.display="block";
    return;
  }

  // ===== MODES UR / UR-NIVEAU / UR-LOCAL =====
  const groups=new Map();

  rows.forEach(it=>{
    const {level,local}=splitLevelLocal(it.D);
    let key = groupTitleBase(it);
    if(mode==='ur-niveau') key += ` ‚Äì ${level||'NR'}`;
    if(mode==='ur-local')  key += ` ‚Äì ${local||'NR'}`;
    if(!groups.has(key)) groups.set(key,[]);
    groups.get(key).push(it);
  });

  const thExtra = `
  ${(showObs.checked || obsCNPE.checked) ? `<th>Observation</th>` : ''}
  ${showDeg.checked ? `<th>D√©gradation</th>` : ''}
`;

const tdExtra = (it)=> `
  ${showObs.checked ? `<td>${getObservation(it) || ''}</td>` : ''}
  ${showDeg.checked ? `<td>${it.M||''}</td>` : ''}
`;


  for(const [k,items] of groups){
    let html=`<table>${CG}
      <tr class="local-title"><td colspan="${COLS}">${k}</td></tr>
      <tr class="table-header">
        <th>UR</th><th>N¬∞ mesure</th><th>Niveau</th><th>Local</th>
        <th>Zone</th><th>Substrat</th><th>Rev√™tement apparent</th>
                <th>Teneur en plomb en mg/cm¬≤</th><th>Incertitude de la mesure +/-  en mg/cm¬≤</th>${thExtra}
      </tr>`;

    items.forEach(it=>{
      const {level,local}=splitLevelLocal(it.D);
      let inc=it.Q;
      const res=parseNumber(it.K);
      if((inc===''||inc==null)&&!isNaN(res)){
        inc=Math.max(0.01,res*(parseNumber(uncertaintyPct.value)/100)).toFixed(2);
      }
      const ur=(urMode==='auto')?it.UR_AUTO:(it.F||'');
      html+=`<tr>
        <td>${ur}</td><td>${it.C||''}</td>
        <td>${level}</td><td>${local}</td>
        <td>${buildZone(it)}</td>
        <td>${it.H||''}</td>
        <td>${it.I||''}</td>
        <td style="background:${getColor(it.K)}">${formatPlombValue(it.K)}</td>
        <td>${inc||''}</td>${tdExtra(it)}
      </tr>`;
    });

    html+=`</table>`;
    previewArea.insertAdjacentHTML("beforeend",html);
  }

  const legend = buildLegend();
  if(legend){
    previewArea.insertAdjacentHTML("beforeend", legend);
  }

  previewContainer.style.display="block";
}
/* ===================== WORD ‚Äì INLINE STYLES ===================== */
function inlineForWord(table){

  // ===== Titres =====
  table.querySelectorAll('tr.local-title td').forEach(td=>{
    td.style.background = '#00ACE8';
    td.style.color = '#ffffff';
    td.style.fontWeight = '700';
    td.style.fontSize = '11pt';
    td.style.textTransform = 'uppercase';
    td.style.letterSpacing = '0.6px';
  });

  table.querySelectorAll('tr.ur-title td').forEach(td=>{
    td.style.background = '#d6e4f5';
    td.style.color = '#000000';
    td.style.fontWeight = '600';
    td.style.fontSize = '9.5pt';
  });

  table.querySelectorAll('tr.table-header th').forEach(th=>{
    th.style.background = '#eef3f8';
    th.style.color = '#000000';
    th.style.fontWeight = '600';
    th.style.fontSize = '8.5pt';
    th.style.textAlign = 'center';
    th.style.verticalAlign = 'middle';
  });

  // ===== Style global cellules =====
  table.querySelectorAll('td, th').forEach(cell=>{
    cell.style.border = '1px solid #000';
    cell.style.padding = '4px';
    cell.style.fontFamily = 'Arial';
    cell.style.fontSize = '8pt';
    cell.style.verticalAlign = 'top';
    cell.style.wordBreak = 'break-word';
    cell.style.whiteSpace = 'normal';
  });

  // ===== FOR√áAGE LARGEUR WORD (COLONNES 8 & 9) =====
  table.querySelectorAll('tr').forEach(tr=>{
    const cells = tr.children;
    if(cells.length >= 9){
      // Colonne 8 : Teneur plomb
      cells[7].style.width = '2cm';
      cells[7].style.maxWidth = '2cm';

      // Colonne 9 : Incertitude
      cells[8].style.width = '2cm';
      cells[8].style.maxWidth = '2cm';
    }
  });

  table.style.borderCollapse = 'collapse';
  table.style.width = '100%';
  table.style.tableLayout = 'fixed'; // üîë indispensable pour Word
}


/* ===================== COPY WORD ===================== */
copyAllBtn.onclick = async () => {
  let html = `<style>
    table{border-collapse:collapse;width:100%;font-family:Arial;font-size:8pt}
    td,th{border:1px solid #000;padding:4px}
  </style>`;

document.querySelectorAll("#previewArea table").forEach(t=>{
  const clone = t.cloneNode(true);
  inlineForWord(clone);
  html += clone.outerHTML;
  html += `<p style="margin:8pt 0">&nbsp;</p>`;
});


  try{
    await navigator.clipboard.write([
      new ClipboardItem({
        'text/html': new Blob([html], { type:'text/html' })
      })
    ]);

    const oldText = copyAllBtn.textContent;
    const oldBg   = copyAllBtn.style.background;

    copyAllBtn.textContent = "‚úî Tableaux copi√©s";
    copyAllBtn.style.background = "#00B894";

    setTimeout(()=>{
      copyAllBtn.textContent = oldText;
      copyAllBtn.style.background = oldBg;
    }, 2000);

  }catch(e){
    alert("Erreur lors de la copie dans le presse-papiers");
  }
};
	});
</script>

</body>
</html>
